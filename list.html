<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrations â€” Logic Legend</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#1e3c72;--bg2:#27ae60;--card:#fff;--accent:#27ae60;--shadow:0 14px 40px rgba(11,22,39,0.12)}
    html,body{height:100%;margin:0}
    body{font-family:'Inter',Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:100%;max-width:900px;background:var(--card);border-radius:16px;padding:22px;box-shadow:var(--shadow)}
    h1{margin:0 0 6px;font-size:20px;color:#10203a}
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;color:#334155;border:1px solid #e6edf3}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:10px 12px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
    th{background:transparent;color:#10203a;font-weight:600}
    .muted{color:#6b7280;font-size:13px}
    .actions button{margin-right:8px}
    .empty{padding:18px;text-align:center;color:#475569}
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Saved Registrations</h1>
        <div class="muted">All locally saved registrations (stored in browser localStorage)</div>
      </div>
      <div class="controls">
        <button id="refresh" class="btn ghost">Refresh</button>
        <button id="export" class="btn">Export JSON</button>
        <button id="clearAll" class="btn ghost">Clear All</button>
        <button id="home" class="btn">Home</button>
      </div>
    </div>

    <div id="listContainer"></div>

  </div>

  <script>
    function loadUsers(){
      const index = JSON.parse(localStorage.getItem('users_index')||'[]');
      const container = document.getElementById('listContainer');
      if (!index.length){ container.innerHTML = '<div class="empty">No registrations yet.</div>'; return }

      let html = '<table><thead><tr><th>#</th><th>Name</th><th>Aadhar</th><th>Phone</th><th>Ward</th><th>House</th><th>Actions</th></tr></thead><tbody>';
      index.forEach((id,i)=>{
        const raw = localStorage.getItem('user:' + id);
        const u = raw ? JSON.parse(raw) : { id };
        html += `<tr data-id="${id}"><td>${i+1}</td><td>${escapeHtml(u.name||'')}</td><td>${escapeHtml(u.aadhar||'')}</td><td>${escapeHtml(u.phone||'')}</td><td>${escapeHtml(u.ward||'')}</td><td>${escapeHtml(u.house||'')}</td><td class="actions"><button data-id="${id}" class="btn ghost view">View</button><button data-id="${id}" class="btn ghost del">Delete</button></td></tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;

      // attach handlers
      container.querySelectorAll('button.view').forEach(b=> b.addEventListener('click', e=>{
        const id = e.currentTarget.dataset.id; window.location.href = 'welcome.html?userId=' + encodeURIComponent(id);
      }));
      container.querySelectorAll('button.del').forEach(b=> b.addEventListener('click', e=>{
        const id = e.currentTarget.dataset.id; if (!confirm('Delete this registration?')) return; deleteUser(id); loadUsers();
      }));
    }

    function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]}); }

    function deleteUser(id){
      // remove per-user record and remove from index
      localStorage.removeItem('user:' + id);
      const index = JSON.parse(localStorage.getItem('users_index')||'[]');
      const newIndex = index.filter(x=> x !== id);
      localStorage.setItem('users_index', JSON.stringify(newIndex));
      // remove per-user materials if exist
      localStorage.removeItem('materials:' + id);
    }

    document.getElementById('export').addEventListener('click', ()=>{
      const index = JSON.parse(localStorage.getItem('users_index')||'[]');
      const users = index.map(id => JSON.parse(localStorage.getItem('user:' + id) || '{}'));
      const blob = new Blob([JSON.stringify(users, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='registrations.json'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('clearAll').addEventListener('click', ()=>{
      if (!confirm('Clear all registrations? This cannot be undone.')) return; localStorage.removeItem('users'); loadUsers();
    });

    document.getElementById('refresh').addEventListener('click', loadUsers);
    document.getElementById('home').addEventListener('click', ()=> window.location.href='Untitled-1.html');

    // initial load
    loadUsers();
  </script>
</body>
</html>
